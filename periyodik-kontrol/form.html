<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Periyodik Kontrol - Veri Olu≈üturucu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-x: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #17a2b8;
            padding-bottom: 15px;
            margin-bottom: 20px;
            min-width: 1500px;
        }
        
        .header h1 {
            color: #17a2b8;
            font-size: 24px;
            margin: 0;
            flex-shrink: 0;
        }
        
        .header-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            flex-shrink: 0;
        }
        
        .toggle-container {
            display: inline-flex;
            background: #607D8B;
            border-radius: 20px;
            padding: 3px;
            margin-right: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .toggle-btn {
            background: transparent;
            color: rgba(255,255,255,0.7);
            padding: 6px 15px;
            border: none;
            border-radius: 17px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .toggle-btn.active {
            background: white;
            color: #607D8B;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-btn:hover:not(.active) {
            color: white;
        }
        
        .btn-personel {
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            margin-right: 15px;
        }
        
        .btn-personel:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .data-table {
            margin-bottom: 20px;
            min-width: 1500px;
        }
        
        /* Tablo benzeri yapƒ± i√ßin header */
        .table-header {
            display: flex;
            background: #e9ecef;
            padding: 10px;
            border-radius: 6px 6px 0 0;
            border: 1px solid #dee2e6;
            border-bottom: none;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 0;
            width: 100%;
        }
        
        .table-cell {
            padding: 0 5px;
            white-space: nowrap;
            text-align: center;
            flex-shrink: 0;
        }
        
        .cell-row { 
            width: 40px;
            text-align: center;
        }
        
        .cell-tur { 
            width: 60px;
            text-align: center;
        }
        
        .cell-sgk { 
            width: 240px;
            text-align: center;
        }
        
        .cell-tc { 
            width: 120px;
            text-align: center;
        }
        
        .cell-equip { 
            width: 80px; 
            text-align: center;
            padding-left: 5px;
        }
        
        .form-rows-container {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: none;
            overflow-y: visible;
            width: 100%;
        }
        
        .form-row {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #dee2e6;
            background: white;
            width: 100%;
        }
        
        .form-row:last-child {
            border-bottom: none;
        }
        
        .form-row:hover {
            background: #f8f9fa;
        }
        
        .row-number {
            width: 40px;
            text-align: center;
            font-weight: bold;
            color: #17a2b8;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .form-group {
            padding: 0 5px;
            flex-shrink: 0;
        }
        
        .input-row {
            width: 60px;
        }
        
        .input-sgk {
            width: 240px;
        }
        
        .input-tc {
            width: 120px;
            position: relative; /* Dropdown i√ßin */
        }
        
        .input-equip {
            width: 80px;
        }
        
        input[type="text"],
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
            width: 100%;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #17a2b8;
            box-shadow: 0 0 0 2px rgba(23, 162, 184, 0.1);
        }
        
        input[type="number"] {
            text-align: center;
        }
        
        .fill-down-btn {
            width: 24px;
            height: 34px;
            padding: 0;
            background: #17a2b8;
            color: white;
            border: 1px solid #138496;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-left: 2px;
        }
        
        .fill-down-btn:hover {
            background: #138496;
            transform: scale(1.1);
        }
        
        .fill-down-btn:active {
            transform: scale(0.95);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: flex-start;
            min-width: 1500px;
        }
        
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-add-row {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-add-row:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }
        
        .btn-submit {
            background: #17a2b8;
            color: white;
        }
        
        .btn-submit:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        .btn-clear {
            background: #6c757d;
            color: white;
        }
        
        .btn-clear:hover {
            background: #5a6268;
        }
        
        .btn-copy {
            background: #17a2b8;
            color: white;
        }
        
        .btn-copy:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        .btn-send {
            background: #28a745;
            color: white;
        }
        
        .btn-send:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .output-section {
            margin-top: 30px;
            min-width: 1500px;
        }
        
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .output-header h3 {
            color: #495057;
            font-size: 16px;
        }
        
        .counter {
            background: #17a2b8;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }
        
        #output {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            background: #fff;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
            animation: fadeIn 0.3s;
            min-width: 1250px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .error {
            border-color: #dc3545 !important;
        }
        
        /* Personel Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #17a2b8;
        }
        
        .modal-header h2 {
            color: #17a2b8;
            margin: 0;
            font-size: 22px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #dc3545;
        }
        
        .personel-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .personel-form h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #495057;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr auto;
            gap: 15px;
            align-items: end;
        }
        
        .form-field label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .form-field input,
        .form-field select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-field input:focus,
        .form-field select:focus {
            outline: none;
            border-color: #17a2b8;
            box-shadow: 0 0 0 2px rgba(23, 162, 184, 0.1);
        }
        
        .personel-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        
        .personel-list h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #495057;
        }
        
        .search-box {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .personel-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .personel-table thead {
            background: #e9ecef;
        }
        
        .personel-table th {
            padding: 10px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #495057;
        }
        
        .personel-table td {
            padding: 10px;
            border-top: 1px solid #dee2e6;
            font-size: 14px;
        }
        
        .personel-table tr:hover {
            background: #f8f9fa;
        }
        
        .action-btns {
            display: flex;
            gap: 5px;
        }
        
        .btn-edit,
        .btn-delete {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-edit:hover {
            background: #e0a800;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .personel-stats {
            margin-top: 15px;
            padding: 10px;
            background: #d1ecf1;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            color: #0c5460;
        }
        
        .personel-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .btn-export,
        .btn-import,
        .btn-delete-all {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-export {
            background: #17a2b8;
            color: white;
        }
        
        .btn-export:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        .btn-import {
            background: #28a745;
            color: white;
        }
        
        .btn-import:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .btn-delete-all {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete-all:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .no-data {
            text-align: center;
            padding: 30px;
            color: #6c757d;
            font-style: italic;
        }
        
        /* TC Input Dropdown */
        .tc-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            min-width: 300px; /* Minimum geni≈ülik */
            white-space: nowrap; /* Tek satƒ±rda g√∂ster */
        }
        
        .tc-dropdown.active {
            display: block;
        }
        
        .tc-dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
            white-space: nowrap; /* Tek satƒ±rda g√∂ster */
            overflow: hidden;
            text-overflow: ellipsis; /* √áok uzunsa ... koy */
        }
        
        .tc-dropdown-item.tc-dropdown-gorev {
            background: #e7f3ff;
            font-weight: bold;
            color: #0056b3;
        }
        
        .tc-dropdown-item.tc-dropdown-gorev:hover {
            background: #cce5ff;
        }
        
        .tc-dropdown-item:hover,
        .tc-dropdown-item.selected {
            background: #e9ecef;
        }
        
        .tc-dropdown-item:last-child {
            border-bottom: none;
        }

        /* Progress Bar */
        .progress-section {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            min-width: 1500px;
        }

        .progress-section.show {
            display: block;
        }

        .progress-header {
            font-size: 18px;
            font-weight: bold;
            color: #17a2b8;
            margin-bottom: 15px;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #17a2b8, #28a745);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .progress-messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .progress-status {
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #17a2b8;
        }

        .progress-status.success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .progress-status.error {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .progress-detail {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .result-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .result-card {
            padding: 15px;
            background: white;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .result-card.success {
            border-left: 4px solid #28a745;
        }

        .result-card.error {
            border-left: 4px solid #dc3545;
        }

        .result-card.info {
            border-left: 4px solid #17a2b8;
        }

        .result-card-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .result-card-label {
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Periyodik Kontrol - Veri Olu≈üturucu</h1>
            <div class="header-buttons">
                <div class="toggle-container">
                    <button type="button" class="toggle-btn active" data-mode="sgk">SGK No</button>
                    <button type="button" class="toggle-btn" data-mode="detsis">DetSis No</button>
                </div>
                <button type="button" class="btn-personel" onclick="openPersonelModal()">üë• Personeller</button>
                <button type="button" class="btn-add-row" onclick="addRows(1)">‚ûï 1 Satƒ±r</button>
                <button type="button" class="btn-add-row" onclick="addRows(5)">‚ûï 5 Satƒ±r</button>
                <button type="button" class="btn-add-row" onclick="addRows(10)">‚ûï 10 Satƒ±r</button>
            </div>
        </div>
        
        <div class="data-table">
            <!-- Tablo Header -->
            <div class="table-header">
                <div class="table-cell cell-row">#</div>
                <div class="table-cell cell-tur">T√ºr</div>
                <div class="table-cell cell-sgk" id="isyeriLabel">SGK No (26)</div>
                <div style="width: 26px;"></div> <!-- SGK fill-down butonu bo≈üluƒüu -->
                <div class="table-cell cell-tc">TC No (11)</div>
                <div style="width: 26px;"></div> <!-- TC fill-down butonu bo≈üluƒüu -->
                <div class="table-cell cell-equip" title="Basƒ±n√ßlƒ± Kap">BK</div>
                <div class="table-cell cell-equip" title="Kaldƒ±rma Ekipmanƒ±">KE</div>
                <div class="table-cell cell-equip" title="Tesisat">TS</div>
                <div class="table-cell cell-equip" title="Tezgah">TZ</div>
                <div class="table-cell cell-equip" title="Raf">RF</div>
                <div class="table-cell cell-equip" title="ƒ∞≈ü Makinesi">ƒ∞M</div>
                <div class="table-cell cell-equip" title="LPG Tankƒ±">LP</div>
                <div class="table-cell cell-equip" title="Y√ºr√ºyen Merdiven">YM</div>
                <div class="table-cell cell-equip" title="Kule Kren">KK</div>
                <div class="table-cell cell-equip" title="Asƒ±lƒ± Eri≈üim">AE</div>
            </div>
            
            <!-- Form Satƒ±rlarƒ± -->
            <div class="form-rows-container" id="formRowsContainer">
                <!-- Satƒ±rlar buraya JavaScript ile eklenecek -->
            </div>
        </div>
        
        <!-- Butonlar -->
        <div class="action-buttons">
            <button type="button" class="btn-submit" onclick="submitAllRows()">üìã T√ºm√ºn√º Ekle</button>
            <button type="button" class="btn-clear" onclick="clearAllRows()">üóëÔ∏è Formu Temizle</button>
        </div>
        
        <div id="successMessage" class="success-message">
            ‚úÖ Veriler ba≈üarƒ±yla eklendi!
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-section" id="progressSection">
            <div class="progress-header" id="progressHeader">ƒ∞≈ülem Devam Ediyor...</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
            <div class="progress-messages" id="progressMessages"></div>
            <div class="result-summary" id="resultSummary" style="display: none;"></div>
        </div>
        
        <!-- √áƒ±ktƒ± -->
        <div class="output-section">
            <div class="output-header">
                <h3>üì§ Script ƒ∞√ßin Veri (Kopyalayƒ±n)</h3>
                <span class="counter" id="counter">0 kayƒ±t</span>
            </div>
            <textarea id="output" placeholder="Buraya eklediƒüiniz veriler g√∂r√ºnecek..."></textarea>
            <div class="action-buttons">
                <button class="btn-send" onclick="sendToISGKatip()">üöÄ ƒ∞SG Katip'e G√∂nder</button>
                <button class="btn-copy" onclick="copyToClipboard()">üìã T√ºm√ºn√º Kopyala</button>
                <button class="btn-clear" onclick="clearOutput()">üóëÔ∏è √áƒ±ktƒ±yƒ± Temizle</button>
            </div>
        </div>
    </div>
    
    <!-- Personel Y√∂netimi Modal -->
    <div class="modal-overlay" id="personelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üë• Personel Y√∂netimi</h2>
                <button class="modal-close" onclick="closePersonelModal()">√ó</button>
            </div>
            
            <!-- Personel Ekleme Formu -->
            <div class="personel-form">
                <h3>Yeni Personel Ekle</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label>TC No <span style="color: #dc3545;">*</span></label>
                        <input type="text" id="personelTc" maxlength="11" placeholder="11 haneli">
                    </div>
                    <div class="form-field">
                        <label>Ad Soyad <span style="color: #dc3545;">*</span></label>
                        <input type="text" id="personelAd" placeholder="√ñrn: Ahmet Yƒ±lmaz">
                    </div>
                    <div class="form-field">
                        <label>G√∂rev <span style="color: #dc3545;">*</span></label>
                        <select id="personelGorev">
                            <option value="Elektrik">Elektrik</option>
                            <option value="Mekanik">Mekanik</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <button type="button" id="personelSubmitBtn" class="btn-submit" onclick="savePersonel()" style="height: 36px; margin: 0;">‚ûï Ekle</button>
                    </div>
                </div>
            </div>
            
            <!-- Personel Listesi -->
            <div class="personel-list">
                <h3>Personel Listesi</h3>
                <input type="text" class="search-box" id="personelSearch" placeholder="üîç Ara... (TC, Ad Soyad veya G√∂rev)">
                
                <div id="personelTableContainer">
                    <!-- Tablo JavaScript ile doldurulacak -->
                </div>
                
                <div class="personel-stats" id="personelStats">
                    üìä Toplam: 0 personel
                </div>
                
                <div class="personel-actions">
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importPersonel(event)">
                    <button class="btn-export" onclick="exportPersonel()">üì§ Dƒ±≈üa Aktar</button>
                    <button class="btn-import" onclick="document.getElementById('importFile').click()">üì• ƒ∞√ße Aktar</button>
                    <button class="btn-delete-all" onclick="deleteAllPersonel()">üóëÔ∏è T√ºm√ºn√º Sil</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let rowCount = 0;
        let dataLines = [];
        let editingPersonelId = null; // D√ºzenleme modu i√ßin
        let currentMode = 'sgk'; // default: sgk
        
        // ============ TOGGLE FONKSƒ∞YONELLƒ∞ƒûƒ∞ ============
        
        // Toggle butonlarƒ± i√ßin event listener ekle
        document.addEventListener('DOMContentLoaded', function() {
            const toggleButtons = document.querySelectorAll('.toggle-btn');
            
            toggleButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const newMode = this.getAttribute('data-mode');
                    
                    if (newMode === currentMode) return; // Zaten aktif
                    
                    // Deƒüi≈üiklik yapƒ±lmadan √∂nce uyar
                    if (dataLines.length > 0) {
                        if (!confirm('‚ö†Ô∏è Mod deƒüi≈ütirdiƒüinizde mevcut veriler temizlenecek!\n\nDevam etmek istiyor musunuz?')) {
                            return;
                        }
                    }
                    
                    // Toggle aktif/pasif
                    toggleButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Modu deƒüi≈ütir
                    currentMode = newMode;
                    updateUIForMode(newMode);
                    
                    // Formu temizle
                    clearAllRows();
                });
            });
        });
        
        // UI'yi moda g√∂re g√ºncelle
        function updateUIForMode(mode) {
            const isyeriLabel = document.getElementById('isyeriLabel');
            const isDetsis = mode === 'detsis';
            const isyeriHane = isDetsis ? 8 : 26;
            const isyeriPlaceholder = isDetsis ? '8 haneli DetSis No' : '26 haneli SGK No';
            
            // Header label'ƒ± g√ºncelle
            if (mode === 'sgk') {
                isyeriLabel.textContent = 'SGK No (26)';
            } else {
                isyeriLabel.textContent = 'DetSis No (8)';
            }
            
            // MEVCUT t√ºm satƒ±rlardaki inputlarƒ± g√ºncelle
            document.querySelectorAll('.sgk-input').forEach(input => {
                input.placeholder = isyeriPlaceholder;
                input.maxLength = isyeriHane;
                // Mevcut deƒüeri temizle (hane sayƒ±sƒ± deƒüi≈üti)
                input.value = '';
            });
        }
        
        // ============ PERSONEL Y√ñNETƒ∞Mƒ∞ ============
        
        // LocalStorage'dan personelleri al
        function getPersoneller() {
            const data = localStorage.getItem('isgPersoneller');
            return data ? JSON.parse(data) : [];
        }
        
        // LocalStorage'a personelleri kaydet
        function savePersoneller(personeller) {
            localStorage.setItem('isgPersoneller', JSON.stringify(personeller));
        }
        
        // Modal a√ß
        function openPersonelModal() {
            document.getElementById('personelModal').classList.add('active');
            loadPersonelList();
            
            // ƒ∞lk input'a focus
            setTimeout(() => {
                document.getElementById('personelTc').focus();
            }, 100);
        }
        
        // Modal kapat
        function closePersonelModal() {
            document.getElementById('personelModal').classList.remove('active');
            clearPersonelForm();
        }
        
        // Formu temizle
        function clearPersonelForm() {
            document.getElementById('personelTc').value = '';
            document.getElementById('personelAd').value = '';
            document.getElementById('personelGorev').value = 'Elektrik';
            editingPersonelId = null;
            document.getElementById('personelSubmitBtn').textContent = '‚ûï Ekle';
        }
        
        // Personel kaydet/g√ºncelle
        function savePersonel() {
            const tc = document.getElementById('personelTc').value.trim();
            const ad = document.getElementById('personelAd').value.trim();
            const gorev = document.getElementById('personelGorev').value;
            
            // Validasyon
            if (!tc || tc.length !== 11 || !/^\d{11}$/.test(tc)) {
                alert('‚ö†Ô∏è TC No 11 haneli sayƒ± olmalƒ±dƒ±r!');
                document.getElementById('personelTc').focus();
                return;
            }
            
            if (!ad) {
                alert('‚ö†Ô∏è Ad Soyad bo≈ü olamaz!');
                document.getElementById('personelAd').focus();
                return;
            }
            
            const personeller = getPersoneller();
            
            if (editingPersonelId) {
                // G√ºncelleme
                const index = personeller.findIndex(p => p.id === editingPersonelId);
                if (index !== -1) {
                    personeller[index] = {
                        id: editingPersonelId,
                        tc: tc,
                        adSoyad: ad,
                        gorev: gorev
                    };
                }
            } else {
                // Yeni ekleme - TC kontrol√º
                if (personeller.some(p => p.tc === tc)) {
                    alert('‚ö†Ô∏è Bu TC No zaten kayƒ±tlƒ±!');
                    return;
                }
                
                personeller.push({
                    id: Date.now().toString(),
                    tc: tc,
                    adSoyad: ad,
                    gorev: gorev
                });
            }
            
            savePersoneller(personeller);
            loadPersonelList();
            clearPersonelForm();
            
            // Ba≈üarƒ± mesajƒ±
            const msg = editingPersonelId ? 'g√ºncellendi' : 'eklendi';
            alert(`‚úÖ ${ad} ${msg}!`);
        }
        
        // Personel listesini y√ºkle
        function loadPersonelList() {
            const personeller = getPersoneller();
            const searchInput = document.getElementById('personelSearch');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            console.log('Personel listesi y√ºkleniyor, toplam:', personeller.length);
            console.log('Arama terimi:', searchTerm);
            
            // Filtrele
            const filtered = personeller.filter(p => 
                p.tc.includes(searchTerm) ||
                p.adSoyad.toLowerCase().includes(searchTerm) ||
                p.gorev.toLowerCase().includes(searchTerm)
            );
            
            console.log('Filtrelenmi≈ü:', filtered.length);
            
            const container = document.getElementById('personelTableContainer');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="no-data">Hen√ºz personel eklenmemi≈ü</div>';
            } else {
                let html = `
                    <table class="personel-table">
                        <thead>
                            <tr>
                                <th>TC No</th>
                                <th>Ad Soyad</th>
                                <th>G√∂rev</th>
                                <th style="width: 100px; text-align: center;">ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                filtered.forEach(p => {
                    html += `
                        <tr>
                            <td>${p.tc}</td>
                            <td>${p.adSoyad}</td>
                            <td>${p.gorev}</td>
                            <td class="action-btns">
                                <button class="btn-edit" onclick="editPersonel('${p.id}')" title="D√ºzenle">‚úèÔ∏è</button>
                                <button class="btn-delete" onclick="deletePersonel('${p.id}', '${p.adSoyad}')" title="Sil">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            // ƒ∞statistik
            document.getElementById('personelStats').textContent = `üìä Toplam: ${personeller.length} personel`;
        }
        
        // Personel d√ºzenle
        function editPersonel(id) {
            const personeller = getPersoneller();
            const personel = personeller.find(p => p.id === id);
            
            if (personel) {
                document.getElementById('personelTc').value = personel.tc;
                document.getElementById('personelAd').value = personel.adSoyad;
                document.getElementById('personelGorev').value = personel.gorev;
                editingPersonelId = id;
                document.getElementById('personelSubmitBtn').textContent = 'üíæ G√ºncelle';
                
                // Scroll to top
                document.querySelector('.modal-content').scrollTop = 0;
                document.getElementById('personelTc').focus();
            }
        }
        
        // Personel sil
        function deletePersonel(id, adSoyad) {
            if (!confirm(`"${adSoyad}" silinsin mi?`)) {
                return;
            }
            
            let personeller = getPersoneller();
            personeller = personeller.filter(p => p.id !== id);
            savePersoneller(personeller);
            loadPersonelList();
            
            alert(`‚úÖ ${adSoyad} silindi!`);
        }
        
        // T√ºm√ºn√º sil
        function deleteAllPersonel() {
            const personeller = getPersoneller();
            
            if (personeller.length === 0) {
                alert('‚ö†Ô∏è Silinecek personel yok!');
                return;
            }
            
            if (!confirm(`${personeller.length} personel silinecek. Emin misiniz?`)) {
                return;
            }
            
            savePersoneller([]);
            loadPersonelList();
            alert('‚úÖ T√ºm personeller silindi!');
        }
        
        // Export (Dƒ±≈üa Aktar)
        function exportPersonel() {
            const personeller = getPersoneller();
            
            if (personeller.length === 0) {
                alert('‚ö†Ô∏è Dƒ±≈üa aktarƒ±lacak personel yok!');
                return;
            }
            
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                personeller: personeller
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `isg-personeller-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ ${personeller.length} personel dƒ±≈üa aktarƒ±ldƒ±!`);
        }
        
        // Import (ƒ∞√ße Aktar)
        function importPersonel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Format kontrol√º
                    if (!data.personeller || !Array.isArray(data.personeller)) {
                        alert('‚ö†Ô∏è Ge√ßersiz dosya formatƒ±!');
                        return;
                    }
                    
                    const mevcut = getPersoneller();
                    const yeniPersoneller = data.personeller;
                    
                    // Se√ßenek sun
                    let mode = 'ekle';
                    if (mevcut.length > 0) {
                        const choice = confirm(
                            `${mevcut.length} mevcut personel var.\n\n` +
                            `‚úÖ TAMAM: Yeni personelleri EKLE (${mevcut.length + yeniPersoneller.length} toplam)\n` +
                            `‚ùå ƒ∞PTAL: Mevcut personelleri DEƒûƒ∞≈ûTƒ∞R (${yeniPersoneller.length} toplam)`
                        );
                        mode = choice ? 'ekle' : 'degistir';
                    }
                    
                    let finalPersoneller;
                    if (mode === 'ekle') {
                        // TC kontrol√º yaparak ekle
                        const mevcutTCler = new Set(mevcut.map(p => p.tc));
                        const yeniEklenecekler = yeniPersoneller.filter(p => !mevcutTCler.has(p.tc));
                        finalPersoneller = [...mevcut, ...yeniEklenecekler];
                        
                        alert(`‚úÖ ${yeniEklenecekler.length} yeni personel eklendi!\n(${yeniPersoneller.length - yeniEklenecekler.length} tekrarlƒ± atlandƒ±)`);
                    } else {
                        finalPersoneller = yeniPersoneller;
                        alert(`‚úÖ ${yeniPersoneller.length} personel i√ße aktarƒ±ldƒ±! (Eskiler silindi)`);
                    }
                    
                    savePersoneller(finalPersoneller);
                    loadPersonelList();
                    
                } catch (error) {
                    alert('‚ö†Ô∏è Dosya okunamadƒ±: ' + error.message);
                }
                
                // Input'u temizle (aynƒ± dosya tekrar se√ßilebilsin)
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // Arama
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('personelSearch');
            if (searchInput) {
                searchInput.addEventListener('input', loadPersonelList);
            }
            
            // TC input validasyonu
            const tcInput = document.getElementById('personelTc');
            if (tcInput) {
                tcInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 11);
                });
            }
        });
        
        // ============ ANA FORM ============
        
        // Sayfa y√ºklendiƒüinde 10 satƒ±r ekle
        window.addEventListener('DOMContentLoaded', function() {
            addRows(10);
            
            // ƒ∞lk satƒ±rƒ±n SGK inputuna focus
            setTimeout(() => {
                const firstSgkInput = document.getElementById('sgkNo_1');
                if (firstSgkInput) {
                    firstSgkInput.focus();
                }
            }, 100);
        });
        
        // Satƒ±r HTML'i olu≈ütur
        function createRowHTML(rowNumber) {
            const isDetsis = currentMode === 'detsis';
            const isyeriMaxLength = isDetsis ? 8 : 26;
            const isyeriPlaceholder = isDetsis ? '8 haneli DetSis No' : '26 haneli SGK No';
            
            return `
                <div class="form-row" data-row="${rowNumber}">
                    <div class="row-number">${rowNumber}</div>
                    <div class="form-group input-row">
                        <input type="text" id="surecId_${rowNumber}" value="322" readonly tabindex="-1" style="background: #e9ecef; cursor: not-allowed;">
                    </div>
                    <div class="form-group input-sgk">
                        <input type="text" id="sgkNo_${rowNumber}" placeholder="${isyeriPlaceholder}" maxlength="${isyeriMaxLength}" class="sgk-input">
                    </div>
                    <button type="button" class="fill-down-btn" onclick="fillDown('sgkNo', ${rowNumber})" tabindex="-1" title="A≈üaƒüƒ± kopyala (Ctrl+D)">‚ñº</button>
                    <div class="form-group input-tc" style="position: relative;">
                        <input type="text" id="tcNo_${rowNumber}" placeholder="11 haneli" maxlength="11" class="tc-input" data-row="${rowNumber}">
                        <div class="tc-dropdown" id="tcDropdown_${rowNumber}"></div>
                    </div>
                    <button type="button" class="fill-down-btn" onclick="fillDown('tcNo', ${rowNumber})" tabindex="-1" title="A≈üaƒüƒ± kopyala (Ctrl+D)">‚ñº</button>
                    <div class="form-group input-equip">
                        <input type="number" id="basKap_${rowNumber}" value="0" min="0" max="9999" class="equip-input">
                    </div>
                    <div class="form-group input-equip">
                        <input type="number" id="kaldirma_${rowNumber}" value="0" min="0" max="9999" class="equip-input">
                    </div>
                    <div class="form-group input-equip">
                        <input type="number" id="tesisat_${rowNumber}" value="0" min="0" max="9999" class="equip-input">
                    </div>
                    <div class="form-group input-equip">
                        <input type="number" id="tezgah_${rowNumber}" value="0" min="0" max="9999" class="equip-input">
                    </div>
                    <div class="form-group input-equip">
                        <input type="number" id="raf_${rowNumber}" value="0" min="0" max="9999" class="equip-input">
                    </div>
                    <div class="form-group input-equip">
                        <input type="number" id="makine_${rowNumber}" value="0" min="0" max="9999" class="equip-input">
                    </div>
                    <div class="form-group input-equip">
                        <input type="number" id="lpg_${rowNumber}" value="0" min="0" max="9999" class="equip-input">
                    </div>
                    <div class="form-group input-equip">
                        <input type="number" id="merdiven_${rowNumber}" value="0" min="0" max="9999" class="equip-input">
                    </div>
                    <div class="form-group input-equip">
                        <input type="number" id="kren_${rowNumber}" value="0" min="0" max="9999" class="equip-input">
                    </div>
                    <div class="form-group input-equip">
                        <input type="number" id="erisim_${rowNumber}" value="0" min="0" max="9999" class="equip-input">
                    </div>
                    <button type="button" class="fill-down-btn" onclick="fillDownEquipment(${rowNumber})" tabindex="-1" title="Ekipman Sayƒ±larƒ±nƒ± A≈üaƒüƒ± Kopyala">‚ñº</button>
                </div>
            `;
        }
        
        // Satƒ±r ekle
        function addRows(count) {
            const container = document.getElementById('formRowsContainer');
            
            for (let i = 0; i < count; i++) {
                rowCount++;
                container.insertAdjacentHTML('beforeend', createRowHTML(rowCount));
            }
            
            // SGK ve TC input'larƒ±na otomatik temizleme ekle
            setupInputValidation();
        }
        
        // Input validasyon
        function setupInputValidation() {
            document.querySelectorAll('.sgk-input').forEach(input => {
                input.removeEventListener('input', sgkInputHandler);
                input.addEventListener('input', sgkInputHandler);
                
                // Paste event - toplu SGK ekleme
                input.removeEventListener('paste', sgkPasteHandler);
                input.addEventListener('paste', sgkPasteHandler);
            });
            
            document.querySelectorAll('.tc-input').forEach(input => {
                input.removeEventListener('input', tcInputHandler);
                input.addEventListener('input', tcInputHandler);
                
                // TC dropdown setup
                input.removeEventListener('focus', tcFocusHandler);
                input.addEventListener('focus', tcFocusHandler);
                
                input.removeEventListener('blur', tcBlurHandler);
                input.addEventListener('blur', tcBlurHandler);
                
                input.removeEventListener('keydown', tcKeydownHandler);
                input.addEventListener('keydown', tcKeydownHandler);
            });
            
            document.querySelectorAll('.equip-input').forEach(input => {
                input.removeEventListener('input', equipInputHandler);
                input.addEventListener('input', equipInputHandler);
                input.removeEventListener('keydown', equipKeydownHandler);
                input.addEventListener('keydown', equipKeydownHandler);
            });
            
            // T√ºm inputlara Enter tu≈üu navigasyonu ekle
            setupEnterKeyNavigation();
        }
        
        // TC Dropdown Handlers
        let selectedDropdownIndex = -1;
        
        function tcFocusHandler(e) {
            showTcDropdown(e.target);
        }
        
        function tcBlurHandler(e) {
            // √ñnce temizle
            cleanupTcInput(e.target);
            
            // Dropdown'a tƒ±klamaya izin ver
            setTimeout(() => {
                const rowNum = e.target.dataset.row;
                const dropdown = document.getElementById(`tcDropdown_${rowNum}`);
                if (dropdown) {
                    dropdown.classList.remove('active');
                }
                selectedDropdownIndex = -1;
            }, 200);
        }
        
        function tcKeydownHandler(e) {
            const input = e.target;
            const rowNum = input.dataset.row;
            const dropdown = document.getElementById(`tcDropdown_${rowNum}`);
            
            if (!dropdown || !dropdown.classList.contains('active')) {
                return;
            }
            
            const items = dropdown.querySelectorAll('.tc-dropdown-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedDropdownIndex = Math.min(selectedDropdownIndex + 1, items.length - 1);
                updateDropdownSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedDropdownIndex = Math.max(selectedDropdownIndex - 1, 0);
                updateDropdownSelection(items);
            } else if (e.key === 'Enter' && selectedDropdownIndex >= 0) {
                e.preventDefault();
                items[selectedDropdownIndex].click();
            } else if (e.key === 'Escape') {
                dropdown.classList.remove('active');
                selectedDropdownIndex = -1;
            }
        }
        
        function updateDropdownSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedDropdownIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        function showTcDropdown(input) {
            const rowNum = input.dataset.row;
            const dropdown = document.getElementById(`tcDropdown_${rowNum}`);
            
            if (!dropdown) {
                console.error('Dropdown bulunamadƒ±:', `tcDropdown_${rowNum}`);
                return;
            }
            
            const personeller = getPersoneller();
            const searchTerm = input.value.toLowerCase();
            
            console.log('Personel sayƒ±sƒ±:', personeller.length);
            console.log('Arama terimi:', searchTerm);
            
            if (personeller.length === 0) {
                dropdown.classList.remove('active');
                return;
            }
            
            // G√∂rev bazlƒ± say
            const mekanikCount = personeller.filter(p => p.gorev === 'Mekanik').length;
            const elektrikCount = personeller.filter(p => p.gorev === 'Elektrik').length;
            
            // Dropdown'u doldur
            dropdown.innerHTML = '';
            
            // G√∂rev se√ßenekleri (sadece personeli olanlar)
            if (mekanikCount > 0 && 'mekanik'.includes(searchTerm)) {
                const item = document.createElement('div');
                item.className = 'tc-dropdown-item tc-dropdown-gorev';
                item.textContent = `üîß Mekanik (${mekanikCount} personel)`;
                item.onclick = () => selectGorev(rowNum, 'Mekanik');
                dropdown.appendChild(item);
            }
            
            if (elektrikCount > 0 && 'elektrik'.includes(searchTerm)) {
                const item = document.createElement('div');
                item.className = 'tc-dropdown-item tc-dropdown-gorev';
                item.textContent = `‚ö° Elektrik (${elektrikCount} personel)`;
                item.onclick = () => selectGorev(rowNum, 'Elektrik');
                dropdown.appendChild(item);
            }
            
            // Ayƒ±rƒ±cƒ± (eƒüer g√∂revler varsa)
            if ((mekanikCount > 0 || elektrikCount > 0) && personeller.length > 0) {
                const divider = document.createElement('div');
                divider.style.cssText = 'border-top: 2px solid #dee2e6; margin: 5px 0;';
                dropdown.appendChild(divider);
            }
            
            // Personel listesi (filtreli)
            const filtered = personeller.filter(p =>
                p.tc.includes(searchTerm) ||
                p.adSoyad.toLowerCase().includes(searchTerm) ||
                p.gorev.toLowerCase().includes(searchTerm)
            );
            
            console.log('Filtrelenmi≈ü:', filtered.length);
            
            filtered.forEach((p, index) => {
                const item = document.createElement('div');
                item.className = 'tc-dropdown-item';
                item.textContent = `${p.tc} - ${p.adSoyad} (${p.gorev})`;
                item.onclick = () => selectPersonel(rowNum, p);
                dropdown.appendChild(item);
            });
            
            // Hi√ß √∂ƒüe yoksa kapat
            if (dropdown.children.length === 0) {
                dropdown.classList.remove('active');
                return;
            }
            
            // Input'un altƒ±na konumlandƒ±r
            dropdown.style.top = (input.offsetHeight + 2) + 'px';
            dropdown.style.left = '0';
            
            console.log('Dropdown aktif ediliyor...');
            dropdown.classList.add('active');
            selectedDropdownIndex = -1;
        }
        
        function selectPersonel(rowNum, personel) {
            const input = document.getElementById(`tcNo_${rowNum}`);
            input.value = personel.tc;
            input.dataset.type = 'personel'; // Tek ki≈üi
            input.dataset.personelId = personel.id;
            input.dataset.gorev = personel.gorev; // G√∂revi de sakla
            
            const dropdown = document.getElementById(`tcDropdown_${rowNum}`);
            dropdown.classList.remove('active');
            
            // Ekipman inputlarƒ±nƒ± g√∂rev bazlƒ± etkinle≈ütir/pasifle≈ütir
            toggleEquipmentInputs(rowNum, personel.gorev);
            
            // Bir sonraki inputa ge√ß
            focusNextInput(input);
        }
        
        function selectGorev(rowNum, gorev) {
            const input = document.getElementById(`tcNo_${rowNum}`);
            input.value = gorev;
            input.dataset.type = 'gorev'; // Toplu - g√∂rev bazlƒ±
            input.dataset.gorev = gorev;
            
            const dropdown = document.getElementById(`tcDropdown_${rowNum}`);
            dropdown.classList.remove('active');
            
            // Ekipman inputlarƒ±nƒ± g√∂rev bazlƒ± etkinle≈ütir/pasifle≈ütir
            toggleEquipmentInputs(rowNum, gorev);
            
            // Bir sonraki inputa ge√ß
            focusNextInput(input);
        }
        
        // Ekipman inputlarƒ±nƒ± g√∂rev bazlƒ± aktif/pasif yap
        function toggleEquipmentInputs(rowNum, gorev) {
            const equipFields = ['basKap', 'kaldirma', 'tesisat', 'tezgah', 'raf', 'makine', 'lpg', 'merdiven', 'kren', 'erisim'];
            
            if (gorev === 'Elektrik') {
                // Elektrik: Sadece Tesisat aktif
                equipFields.forEach(field => {
                    const input = document.getElementById(`${field}_${rowNum}`);
                    if (input) {
                        if (field === 'tesisat') {
                            input.disabled = false;
                            input.style.backgroundColor = '';
                            input.style.cursor = '';
                        } else {
                            input.disabled = true;
                            input.style.backgroundColor = '#e9ecef';
                            input.style.cursor = 'not-allowed';
                        }
                    }
                });
            } else {
                // Mekanik veya diƒüer: T√ºm√º aktif
                equipFields.forEach(field => {
                    const input = document.getElementById(`${field}_${rowNum}`);
                    if (input) {
                        input.disabled = false;
                        input.style.backgroundColor = '';
                        input.style.cursor = '';
                    }
                });
            }
        }
        
        // TC input blur'da rakam kontrol√º
        function cleanupTcInput(input) {
            // Sadece rakam bƒ±rak
            const cleaned = input.value.replace(/\D/g, '').slice(0, 11);
            if (input.value !== cleaned) {
                input.value = cleaned;
            }
        }
        
        function sgkInputHandler(e) {
            const isDetsis = currentMode === 'detsis';
            const maxLength = isDetsis ? 8 : 26;
            
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, maxLength);
            
            // Maksimum hane doldu mu? Otomatik ge√ßi≈ü
            if (e.target.value.length === maxLength) {
                setTimeout(() => focusNextInput(e.target), 0);
            }
        }
        
        // SGK Paste Handler - Toplu Ekleme
        function sgkPasteHandler(e) {
            const pastedText = e.clipboardData.getData('text');
            const isDetsis = currentMode === 'detsis';
            const maxLength = isDetsis ? 8 : 26;
            const fieldLabel = isDetsis ? 'DetSis No' : 'SGK No';
            
            // √áok satƒ±rlƒ± mƒ± kontrol et
            if (!pastedText.includes('\n') && !pastedText.includes('\r')) {
                // Tek satƒ±r - normal paste
                return;
            }
            
            // √áok satƒ±rlƒ±! Default paste'i engelle
            e.preventDefault();
            
            // Satƒ±rlara b√∂l ve temizle
            const lines = pastedText
                .split(/[\r\n]+/)
                .map(line => line.trim().replace(/\D/g, '').slice(0, maxLength))
                .filter(line => line.length === maxLength); // Sadece doƒüru haneli olanlar
            
            if (lines.length === 0) {
                alert(`‚ö†Ô∏è Ge√ßerli ${fieldLabel} bulunamadƒ±! (${maxLength} haneli sayƒ± olmalƒ±)`);
                return;
            }
            
            // Ba≈ülangƒ±√ß satƒ±rƒ±
            const currentInput = e.target;
            const startRowNum = parseInt(currentInput.id.replace('sgkNo_', ''));
            
            console.log(`${lines.length} ${fieldLabel} yapƒ±≈ütƒ±rƒ±lƒ±yor, ba≈ülangƒ±√ß satƒ±rƒ±: ${startRowNum}`);
            
            let currentRowNum = startRowNum;
            let insertedCount = 0;
            let skippedCount = 0;
            
            lines.forEach((sgkNo, index) => {
                // Mevcut satƒ±r var mƒ±?
                let targetInput = document.getElementById(`sgkNo_${currentRowNum}`);
                
                if (!targetInput) {
                    // Satƒ±r yok, yeni satƒ±r ekle
                    addRows(1);
                    targetInput = document.getElementById(`sgkNo_${currentRowNum}`);
                }
                
                // Satƒ±r dolu mu?
                const existingValue = targetInput.value.trim();
                
                if (existingValue && existingValue.length > 0) {
                    // Satƒ±r dolu - araya ekle
                    console.log(`Satƒ±r ${currentRowNum} dolu, araya ekleniyor...`);
                    insertRowAfter(currentRowNum - 1);
                    targetInput = document.getElementById(`sgkNo_${currentRowNum}`);
                }
                
                // SGK'yƒ± doldur
                if (targetInput) {
                    targetInput.value = sgkNo;
                    insertedCount++;
                    console.log(`Satƒ±r ${currentRowNum}: ${sgkNo}`);
                } else {
                    skippedCount++;
                    console.error(`Satƒ±r ${currentRowNum} bulunamadƒ±!`);
                }
                
                currentRowNum++;
            });
            
            // Sonu√ß mesajƒ±
            let message = `‚úÖ ${insertedCount} SGK No eklendi!`;
            if (skippedCount > 0) {
                message += `\n‚ö†Ô∏è ${skippedCount} satƒ±r atlandƒ±.`;
            }
            alert(message);
            
            // ƒ∞lk eklenen satƒ±ra focus
            const firstInput = document.getElementById(`sgkNo_${startRowNum}`);
            if (firstInput) {
                firstInput.focus();
                firstInput.select();
            }
        }
        
        function tcInputHandler(e) {
            const input = e.target;
            const rowNum = input.dataset.row;
            
            // Maksimum 50 karakter (arama i√ßin)
            if (input.value.length > 50) {
                input.value = input.value.slice(0, 50);
            }
            
            // Dropdown'u g√∂ster
            const hasPersonel = getPersoneller().length > 0;
            if (hasPersonel) {
                showTcDropdown(input);
            }
            
            // Sadece rakam varsa ve 11 hane doluysa otomatik ge√ßi≈ü
            const onlyDigits = /^\d+$/.test(input.value);
            if (onlyDigits && input.value.length === 11) {
                setTimeout(() => focusNextInput(input), 0);
            }
        }
        
        function equipInputHandler(e) {
            let val = e.target.value.replace(/\D/g, '');
            if (val === '') {
                e.target.value = '0';
            } else {
                val = parseInt(val);
                if (val > 9999) val = 9999;
                if (val < 0) val = 0;
                e.target.value = val;
            }
        }
        
        // Ekipman inputlarƒ± i√ßin Enter tu≈üu
        function equipKeydownHandler(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                
                // En son satƒ±rƒ±n en son inputu mu?
                const allInputs = Array.from(document.querySelectorAll('input:not([readonly])'));
                const currentIndex = allInputs.indexOf(e.target);
                
                if (currentIndex === allInputs.length - 1) {
                    // Son input - T√ºm√ºn√º Ekle butonunu aktif et
                    document.querySelector('.btn-submit').focus();
                } else {
                    focusNextInput(e.target);
                }
            }
        }
        
        // Enter tu≈üu ile navigasyon
        function setupEnterKeyNavigation() {
            const allInputs = document.querySelectorAll('input:not([readonly])');
            
            allInputs.forEach((input, index) => {
                // Ekipman inputlarƒ± i√ßin ayrƒ± handler var
                if (input.classList.contains('equip-input')) return;
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        focusNextInput(input);
                    }
                });
            });
        }
        
        // Bir sonraki inputa ge√ß
        function focusNextInput(currentInput) {
            const allInputs = Array.from(document.querySelectorAll('input:not([readonly])'));
            const currentIndex = allInputs.indexOf(currentInput);
            
            if (currentIndex < allInputs.length - 1) {
                allInputs[currentIndex + 1].focus();
                allInputs[currentIndex + 1].select();
            }
        }
        
        // Fill Down (Ctrl+D) - Excel tarzƒ± a≈üaƒüƒ± kopyalama
        function fillDown(fieldPrefix, currentRow) {
            const currentInput = document.getElementById(`${fieldPrefix}_${currentRow}`);
            const value = currentInput.value.trim();
            
            if (!value) {
                alert('‚ö†Ô∏è Kopyalanacak veri yok!');
                return;
            }
            
            // Bir sonraki satƒ±r var mƒ± kontrol et
            const nextRow = currentRow + 1;
            const nextInput = document.getElementById(`${fieldPrefix}_${nextRow}`);
            
            if (!nextInput) {
                // Sonraki satƒ±r yok - yeni satƒ±r ekle
                addRows(1);
                
                // Yeni eklenen satƒ±ra kopyala
                setTimeout(() => {
                    const newInput = document.getElementById(`${fieldPrefix}_${nextRow}`);
                    if (newInput) {
                        newInput.value = value;
                        newInput.focus();
                        newInput.select();
                    }
                }, 50);
                return;
            }
            
            // Sonraki satƒ±r var
            const nextValue = nextInput.value.trim();
            
            if (nextValue) {
                // Alt satƒ±r dolu - araya satƒ±r ekle
                if (confirm(`Satƒ±r ${nextRow} dolu. Araya yeni satƒ±r eklensin mi?`)) {
                    insertRowAfter(currentRow);
                    
                    // Yeni eklenen satƒ±ra kopyala
                    setTimeout(() => {
                        const newInput = document.getElementById(`${fieldPrefix}_${nextRow}`);
                        if (newInput) {
                            newInput.value = value;
                            newInput.focus();
                            newInput.select();
                        }
                    }, 50);
                }
            } else {
                // Alt satƒ±r bo≈ü - direkt kopyala
                nextInput.value = value;
                nextInput.focus();
                nextInput.select();
            }
        }
        
        // Ekipman Sayƒ±larƒ±nƒ± A≈üaƒüƒ± Kopyala (T√ºm ekipman inputlarƒ±)
        function fillDownEquipment(currentRow) {
            // Mevcut satƒ±rdaki t√ºm ekipman deƒüerlerini al
            const equipFields = ['basKap', 'kaldirma', 'tesisat', 'tezgah', 'raf', 'makine', 'lpg', 'merdiven', 'kren', 'erisim'];
            const values = {};
            
            equipFields.forEach(field => {
                const input = document.getElementById(`${field}_${currentRow}`);
                values[field] = input ? input.value : '0';
            });
            
            // Bir sonraki satƒ±r var mƒ± kontrol et
            const nextRow = currentRow + 1;
            const nextRowExists = document.getElementById(`basKap_${nextRow}`);
            
            if (!nextRowExists) {
                // Sonraki satƒ±r yok - yeni satƒ±r ekle
                addRows(1);
                
                // Yeni eklenen satƒ±ra kopyala
                setTimeout(() => {
                    equipFields.forEach(field => {
                        const newInput = document.getElementById(`${field}_${nextRow}`);
                        if (newInput) {
                            newInput.value = values[field];
                        }
                    });
                }, 50);
                return;
            }
            
            // Sonraki satƒ±r var - ekipman inputlarƒ±ndan herhangi biri dolu mu kontrol et
            const nextRowHasData = equipFields.some(field => {
                const input = document.getElementById(`${field}_${nextRow}`);
                return input && input.value.trim() !== '' && input.value !== '0';
            });
            
            if (nextRowHasData) {
                // Alt satƒ±rda ekipman verisi var - kullanƒ±cƒ±ya sor
                const choice = confirm(`Satƒ±r ${nextRow}'da ekipman verisi var.\n\nTAMAM: Araya yeni satƒ±r ekle\nƒ∞PTAL: √úzerine yaz`);
                
                if (choice) {
                    // TAMAM - Araya satƒ±r ekle
                    insertRowAfter(currentRow);
                    
                    // Yeni eklenen satƒ±ra kopyala
                    setTimeout(() => {
                        equipFields.forEach(field => {
                            const newInput = document.getElementById(`${field}_${nextRow}`);
                            if (newInput) {
                                newInput.value = values[field];
                            }
                        });
                    }, 50);
                } else {
                    // ƒ∞PTAL - √úzerine yaz
                    equipFields.forEach(field => {
                        const nextInput = document.getElementById(`${field}_${nextRow}`);
                        if (nextInput) {
                            nextInput.value = values[field];
                        }
                    });
                }
            } else {
                // Alt satƒ±r bo≈ü - direkt kopyala
                equipFields.forEach(field => {
                    const nextInput = document.getElementById(`${field}_${nextRow}`);
                    if (nextInput) {
                        nextInput.value = values[field];
                    }
                });
            }
        }
        
        // Satƒ±rdan sonra yeni satƒ±r ekle
        function insertRowAfter(afterRow) {
            const container = document.getElementById('formRowsContainer');
            const rows = container.querySelectorAll('.form-row');
            
            // Yeni satƒ±r numarasƒ±
            rowCount++;
            const newRowNumber = afterRow + 1;
            
            // Yeni satƒ±r HTML'i olu≈ütur
            const newRowHTML = createRowHTML(newRowNumber);
            
            // Mevcut satƒ±rdan sonraki t√ºm satƒ±rlarƒ± yeniden numaralandƒ±r
            for (let i = rows.length - 1; i >= afterRow; i--) {
                const row = rows[i];
                const oldRowNum = parseInt(row.dataset.row);
                const newRowNum = oldRowNum + 1;
                
                // Satƒ±r numarasƒ±nƒ± g√ºncelle
                row.dataset.row = newRowNum;
                row.querySelector('.row-number').textContent = newRowNum;
                
                // T√ºm inputlarƒ±n ID'lerini g√ºncelle
                updateRowInputIds(row, oldRowNum, newRowNum);
            }
            
            // Yeni satƒ±rƒ± ekle
            if (afterRow === 0) {
                container.insertAdjacentHTML('afterbegin', newRowHTML);
            } else {
                const afterRowElement = rows[afterRow - 1];
                afterRowElement.insertAdjacentHTML('afterend', newRowHTML);
            }
            
            // Validasyon kurulumunu yenile
            setupInputValidation();
        }
        
        // Satƒ±rdaki t√ºm input ID'lerini g√ºncelle
        function updateRowInputIds(row, oldNum, newNum) {
            const inputs = row.querySelectorAll('input');
            
            inputs.forEach(input => {
                const oldId = input.id;
                const newId = oldId.replace(`_${oldNum}`, `_${newNum}`);
                input.id = newId;
            });
            
            // Butonlarƒ±n onclick'lerini g√ºncelle
            const buttons = row.querySelectorAll('.fill-down-btn');
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                const newOnclick = onclick.replace(`, ${oldNum})`, `, ${newNum})`);
                btn.setAttribute('onclick', newOnclick);
            });
        }
        
        // Tek satƒ±rdan veri al (g√∂rev veya tek ki≈üi)
        function getRowData(rowNumber) {
            const surecId = document.getElementById(`surecId_${rowNumber}`).value.trim() || '322';
            const sgkNo = document.getElementById(`sgkNo_${rowNumber}`).value.trim();
            const tcInput = document.getElementById(`tcNo_${rowNumber}`);
            const tcValue = tcInput.value.trim();
            const dataType = tcInput.dataset.type; // 'personel' veya 'gorev'
            
            // Bo≈ü satƒ±rlarƒ± atla
            if (!sgkNo && !tcValue) {
                return null;
            }
            
            // ƒ∞≈üyeri no validasyonu (mode'a g√∂re)
            const isDetsis = currentMode === 'detsis';
            const isyeriHane = isDetsis ? 8 : 26;
            const isyeriLabel = isDetsis ? 'DetSis No' : 'SGK No';
            const isyeriRegex = new RegExp(`^\\d{${isyeriHane}}$`);
            
            if (sgkNo.length !== isyeriHane || !isyeriRegex.test(sgkNo)) {
                return { error: `Satƒ±r ${rowNumber}: ${isyeriLabel} ${isyeriHane} haneli sayƒ± olmalƒ±` };
            }
            
            // Ekipman sayƒ±larƒ±
            const tcGorev = tcInput.dataset.gorev; // Se√ßilen g√∂rev
            
            // Elektrik personeli i√ßin sadece Tesisat
            let basKap, kaldirma, tesisat, tezgah, raf, makine, lpg, merdiven, kren, erisim;
            
            if (tcGorev === 'Elektrik' || (dataType === 'gorev' && tcInput.dataset.gorev === 'Elektrik')) {
                // Elektrik: Sadece Tesisat
                basKap = '0';
                kaldirma = '0';
                tesisat = document.getElementById(`tesisat_${rowNumber}`).value || '0';
                tezgah = '0';
                raf = '0';
                makine = '0';
                lpg = '0';
                merdiven = '0';
                kren = '0';
                erisim = '0';
                
                // BO≈û SATIR KONTROL√ú - ELEKTRƒ∞K
                // Elektrik: Sadece Tesisat var, o da 0 ise atla
                if (parseInt(tesisat) === 0) {
                    return null; // Bo≈ü satƒ±r olarak deƒüerlendir
                }
            } else {
                // Mekanik veya diƒüer: T√ºm√º
                basKap = document.getElementById(`basKap_${rowNumber}`).value || '0';
                kaldirma = document.getElementById(`kaldirma_${rowNumber}`).value || '0';
                tesisat = document.getElementById(`tesisat_${rowNumber}`).value || '0';
                tezgah = document.getElementById(`tezgah_${rowNumber}`).value || '0';
                raf = document.getElementById(`raf_${rowNumber}`).value || '0';
                makine = document.getElementById(`makine_${rowNumber}`).value || '0';
                lpg = document.getElementById(`lpg_${rowNumber}`).value || '0';
                merdiven = document.getElementById(`merdiven_${rowNumber}`).value || '0';
                kren = document.getElementById(`kren_${rowNumber}`).value || '0';
                erisim = document.getElementById(`erisim_${rowNumber}`).value || '0';
                
                // BO≈û SATIR KONTROL√ú - MEKANƒ∞K
                // T√úM ekipman kolonlarƒ± (Akreditasyon dahil) toplamƒ± 0 ise atla
                const mekanikTotal = parseInt(basKap) + parseInt(kaldirma) + parseInt(tesisat) + 
                                    parseInt(tezgah) + parseInt(raf) + parseInt(makine) +
                                    parseInt(lpg) + parseInt(merdiven) + parseInt(kren) + parseInt(erisim);
                
                if (mekanikTotal === 0) {
                    return null; // Bo≈ü satƒ±r olarak deƒüerlendir
                }
            }
            
            // G√∂rev se√ßilmi≈üse - √ßoƒüalt
            if (dataType === 'gorev') {
                const gorev = tcInput.dataset.gorev;
                const personeller = getPersoneller().filter(p => p.gorev === gorev);
                
                if (personeller.length === 0) {
                    return { error: `Satƒ±r ${rowNumber}: ${gorev} personeli yok, atlandƒ±`, warning: true };
                }
                
                // Her personel i√ßin kayƒ±t olu≈ütur
                const records = personeller.map(p => 
                    `${surecId};${sgkNo};${p.tc};${basKap};${kaldirma};${tesisat};${tezgah};${raf};${makine};${lpg};${merdiven};${kren};${erisim}`
                );
                
                return { type: 'gorev', gorev: gorev, count: personeller.length, records: records };
            }
            
            // Tek ki≈üi se√ßilmi≈üse - TC validasyonu
            if (tcValue.length !== 11 || !/^\d{11}$/.test(tcValue)) {
                return { error: `Satƒ±r ${rowNumber}: TC No 11 haneli sayƒ± olmalƒ±` };
            }
            
            return `${surecId};${sgkNo};${tcValue};${basKap};${kaldirma};${tesisat};${tezgah};${raf};${makine};${lpg};${merdiven};${kren};${erisim}`;
        }
        
        // T√ºm satƒ±rlarƒ± i≈üle
        function submitAllRows() {
            const errors = [];
            const warnings = [];
            const newLines = [];
            const skippedRows = [];
            let gorevExpanded = 0; // G√∂rev se√ßimiyle eklenen kayƒ±t sayƒ±sƒ±
            
            for (let i = 1; i <= rowCount; i++) {
                const rowData = getRowData(i);
                
                if (rowData === null) {
                    // Bo≈ü satƒ±r, atla
                    continue;
                }
                
                if (rowData.error) {
                    if (rowData.warning) {
                        warnings.push(rowData.error);
                    } else {
                        errors.push(rowData.error);
                    }
                    skippedRows.push(i);
                } else if (rowData.type === 'gorev') {
                    // G√∂rev se√ßimi - √ßoƒüaltƒ±lmƒ±≈ü kayƒ±tlar
                    gorevExpanded += rowData.count;
                    newLines.push(...rowData.records);
                } else {
                    // Tek kayƒ±t
                    newLines.push(rowData);
                }
            }
            
            // Hi√ß veri yok mu?
            if (newLines.length === 0 && errors.length === 0) {
                alert('‚ö†Ô∏è Hi√ß veri girilmemi≈ü!');
                return;
            }
            
            // Sadece hata var, ge√ßerli veri yok
            if (newLines.length === 0 && errors.length > 0) {
                alert('‚ö†Ô∏è Hi√ß ge√ßerli satƒ±r yok!\n\n' + errors.join('\n'));
                return;
            }
            
            // M√ºkerrerlik kontrol√º (SGK + TC unique olmalƒ±)
            const existingKeys = new Set(dataLines.map(line => {
                const parts = line.split(';');
                return `${parts[1]}_${parts[2]}`; // SGK_TC
            }));
            
            const uniqueNewLines = [];
            const duplicates = [];
            
            newLines.forEach(line => {
                const parts = line.split(';');
                const key = `${parts[1]}_${parts[2]}`; // SGK_TC
                
                if (existingKeys.has(key)) {
                    duplicates.push(`${parts[1]} - ${parts[2]}`);
                } else {
                    existingKeys.add(key);
                    uniqueNewLines.push(line);
                }
            });
            
            // Hi√ß unique kayƒ±t kalmadƒ±ysa
            if (uniqueNewLines.length === 0) {
                alert('‚ö†Ô∏è T√ºm kayƒ±tlar m√ºkerrer! (SGK+TC aynƒ±)\n\n√áƒ±ktƒ±da zaten mevcut.');
                return;
            }
            
            // Verileri ekle
            dataLines = dataLines.concat(uniqueNewLines);
            updateOutput();
            
            // Sonu√ß mesajƒ±
            let message = `‚úÖ ${uniqueNewLines.length} kayƒ±t eklendi!`;
            
            if (gorevExpanded > 0) {
                message += `\n\nüîß G√∂rev se√ßimiyle ${gorevExpanded} personel eklendi`;
            }
            
            if (duplicates.length > 0) {
                message += `\n\n‚ö†Ô∏è ${duplicates.length} m√ºkerrer kayƒ±t atlandƒ± (SGK+TC aynƒ±)`;
            }
            
            if (warnings.length > 0) {
                message += `\n\n‚ö†Ô∏è Uyarƒ±lar:\n` + warnings.join('\n');
            }
            
            if (errors.length > 0) {
                message += `\n\n‚ùå Hatalar:\n` + errors.join('\n');
            }
            
            // Ba≈üarƒ± mesajƒ±
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = `‚úÖ ${uniqueNewLines.length} kayƒ±t eklendi!`;
            successMsg.style.display = 'block';
            setTimeout(() => successMsg.style.display = 'none', 2000);
            
            // Detaylƒ± g√∂ster
            if (gorevExpanded > 0 || duplicates.length > 0 || warnings.length > 0 || errors.length > 0) {
                setTimeout(() => alert(message), 100);
            }
            
            // Form TEMƒ∞ZLENMEZ - Kullanƒ±cƒ± d√ºzeltip tekrar ekleyebilir
        }
        
        // T√ºm satƒ±rlarƒ± temizle
        function clearAllRows() {
            document.getElementById('formRowsContainer').innerHTML = '';
            rowCount = 0;
        }
        
        // √áƒ±ktƒ±yƒ± g√ºncelle
        function updateOutput() {
            document.getElementById('output').value = dataLines.join('\n');
            document.getElementById('counter').textContent = dataLines.length + ' kayƒ±t';
        }
        
        // √áƒ±ktƒ±yƒ± temizle
        function clearOutput() {
            if (dataLines.length === 0) return;
            
            if (confirm(`${dataLines.length} kayƒ±t silinecek. Emin misiniz?`)) {
                dataLines = [];
                updateOutput();
            }
        }
        
        // Kopyala
        function copyToClipboard() {
            const output = document.getElementById('output');
            
            if (dataLines.length === 0) {
                alert('‚ö†Ô∏è Kopyalanacak veri yok!');
                return;
            }
            
            output.select();
            document.execCommand('copy');
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Kopyalandƒ±!';
            btn.style.background = '#28a745';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#17a2b8';
            }, 2000);
        }
        
        // Katibe G√∂nder
        function sendToKatip() {
            if (dataLines.length === 0) {
                alert('‚ö†Ô∏è G√∂nderilecek veri yok!');
                return;
            }
            
            // LocalStorage'a kaydet
            const data = dataLines.join('\n');
            localStorage.setItem('isgKatipPeriyodikKontrolData', data);
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = `‚úÖ ${dataLines.length} kayƒ±t g√∂nderildi!`;
            btn.style.background = '#28a745';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#28a745';
            }, 2000);
            
            alert(`‚úÖ ${dataLines.length} kayƒ±t tarayƒ±cƒ±ya kaydedildi!\n\n≈ûimdi ƒ∞SG Katip'te bookmarklet'i √ßalƒ±≈ütƒ±rabilirsiniz.`);
        }
        
        // ============================================
        // ƒ∞SG KATƒ∞P API FONKSƒ∞YONLARI
        // ============================================
        
        function mk(u,d,t){return fetch(u,{method:'POST',headers:{'Accept':'*/*','Content-Type':'application/json','token':t,'Origin':'https://isgkatip.csgb.gov.tr','Referer':'https://isgkatip.csgb.gov.tr/surec/hizmet-sozlesme-surec'},body:JSON.stringify(d)}).then(r=>r.json())}
        function ts(){return new Date().toISOString().slice(0,-1)}
        function tm(){let d=new Date();d.setDate(d.getDate()+1);return d.toISOString()}
        function t180(){let d=new Date();d.setDate(d.getDate()+180);return d.toISOString()}
        function fn(r,p){if(!r||!r.body||!r.body.flowInstances)return null;const f=r.body.flowInstances.find(x=>x.flowInstancePage?.bsnInterFlowPgId===p);return f?f.businessInteractionFlowInstanceId:r.body.flowInstances[r.body.flowInstances.length-1]?.businessInteractionFlowInstanceId}
        function tm2(m){if(!m)return{t:'',b:false};let s=m.toString();const ok=s.includes('Isleminiz basariyla gerceklestirilmistir')||s.includes('basariyla gerceklestirilmistir');s=s.replace(/Basvuruya ait bir sonraki ekranda islem yapma yetkiniz olmadigindan ana menuye yonlendirileceksiniz\.?/g,'').replace(/isg\.katip\.common\.exception\.business\.IsgBusinessException,\s*/g,'').replace(/\*\*\*/g,'').trim();if(ok)s='Ba≈üarƒ±yla olu≈üturuldu';return{t:s,b:ok}}
        
        async function pk(v){
            const t=sessionStorage.getItem('token');
            if(!t)throw new Error('Token bulunamadƒ±');
            const{tur,sgkNo,tcKimlikNo,basKap,kaldirma,tesisat,tezgah,raf,makine,lpg,merdiven,kren,erisim}=v;
            let id=null,fid=null,fa='-',pa='-';
            const bt=tm(),et=t180();
            
            try{
                const s1=await mk('https://isgkatip.csgb.gov.tr/be/bsn-inter/submit',{body:{businessInteraction:{bsnInterId:tur},operationType:"ADD"}},t);
                if(s1.responseStatus!=='SUCCESS')throw new Error('Ba≈ülatma hatasƒ±');
                id=s1.body.businessInteractionInstanceId;
                fid=s1.body.flowInstances?.[0]?.businessInteractionFlowInstanceId;
                
                const s2=await mk('https://isgkatip.csgb.gov.tr/be/quote/updateFlowInstance',{body:{quoteKey:{businessInteractionInstanceId:id},flowInstancePage:{bsnInterFlowInscId:fid,bsnInterFlowPgId:10143,name:"Info Page",scrOrd:1,postActnStId:1101},page:{type:"isg.katip.common.dto.bsninter.BusinessInteractionPageWarningDTO",isActv:1,isLocked:false,bsnInterPgWrngId:8212,bsnInterPgId:10143,name:"Info Page",businessInteractionName:"CONTRACT PERIODIC CONTROL",businessInteractionInstanceId:id},operation:{isActv:1,businessInteractionPageOperationId:26507,operationActionType:10,businessInteractionPageOperationName:"Next",businessInteractionPageOperationShortCode:"NEXT"}}},t);
                fid=fn(s2,10144);
                
                // Mode'a g√∂re parametreler
                const isDetsis = currentMode === 'detsis';
                const dataTpId = isDetsis ? 281 : 280;
                const bsnInterPrtcptId = isDetsis ? 13288 : 13283;
                
                const s3=await mk('https://isgkatip.csgb.gov.tr/be/bsninter/conf/participant/hasRole',{body:{bsnInterPrtcptId:bsnInterPrtcptId,rowId:sgkNo,dataTpId:dataTpId}},t);
                if(s3.responseStatus!=='SUCCESS')throw new Error(isDetsis ? 'Kamu kurumu bulunamadƒ±' : 'ƒ∞≈üyeri bulunamadƒ±');
                const fr=s3.body?.rowId||sgkNo;
                fa=s3.body?.title||'-';
                
                const s4=await mk('https://isgkatip.csgb.gov.tr/be/quote/updateFlowInstance',{body:{quoteKey:{businessInteractionInstanceId:id},flowInstancePage:{bsnInterFlowInscId:fid,bsnInterFlowPgId:10144,name:"Workplace Selection",descr:"Participant Page",scrOrd:2,postActnStId:1101,isAutoComp:1,isPnr:1},page:{type:"isg.katip.common.dto.bsninter.participant.BusinessInteractionPageParticipantDTO",isActv:1,isLocked:false,bsnInterPgPrtcptId:6146,name:"Workplace Selection",descr:"Participant Page",participants:[{isActv:1,bsnInterPgPrtcptItemId:6146,bsnInterPrtcptId:bsnInterPrtcptId,participantDataTypeId:dataTpId,ruleSetId:1206,verNo:1,name:"Workplace",participantName:"isyeri",rowId:fr,dataTpId:dataTpId}],businessInteractionName:"CONTRACT",businessInteractionInstanceId:id,tarafBilgisi:fr+","+dataTpId},operation:{isActv:1,businessInteractionPageOperationId:26508,operationActionType:10,businessInteractionPageOperationName:"Next",businessInteractionPageOperationShortCode:"NEXT"}}},t);
                fid=fn(s4,10145);
                
                const s5=await mk('https://isgkatip.csgb.gov.tr/be/bsninter/conf/participant/hasRole',{body:{bsnInterPrtcptId:13282,rowId:tcKimlikNo,dataTpId:300}},t);
                if(s5.responseStatus!=='SUCCESS')throw new Error('Personel bulunamadƒ±');
                const pr=s5.body?.rowId||tcKimlikNo;
                pa=s5.body?.title||'-';
                
                const s6=await mk('https://isgkatip.csgb.gov.tr/be/quote/updateFlowInstance',{body:{quoteKey:{businessInteractionInstanceId:id},flowInstancePage:{bsnInterFlowInscId:fid,bsnInterFlowPgId:10145,name:"Personnel Selection",descr:"Participant Page",scrOrd:3,postActnStId:1101,isAutoComp:1,isPnr:1},page:{type:"isg.katip.common.dto.bsninter.participant.BusinessInteractionPageParticipantDTO",isActv:1,isLocked:false,bsnInterPgPrtcptId:6147,name:"Personnel Selection",descr:"Participant Page",participants:[{isActv:1,bsnInterPgPrtcptItemId:6147,bsnInterPrtcptId:13282,participantDataTypeId:300,ruleSetId:1205,verNo:1,name:"Personnel",participantName:"kontrolpersoneli",rowId:pr,dataTpId:300}],businessInteractionName:"CONTRACT",businessInteractionInstanceId:id,tarafBilgisi:fr+","+dataTpId},operation:{isActv:1,businessInteractionPageOperationId:26509,operationActionType:10,businessInteractionPageOperationName:"Next",businessInteractionPageOperationShortCode:"NEXT"}}},t);
                fid=fn(s6,10146);
                
                const ct=ts();
                const cc=(i,l,tg,vl)=>({isActv:1,cdate:ct,cuser:5675110,uuser:5675110,bsnInterPgCharId:i,bsnInterPgLytId:l,charId:tg==="bastar"||tg==="bittar"?22:1,name:"",isOvrdn:0,isOpt:0,tag:tg,isLocked:0,comments:[],gnlChar:{isActv:1,charId:tg==="bastar"||tg==="bittar"?22:1,name:tg==="bastar"||tg==="bittar"?"DATE FIELD":"NUMERIC FIELD",shrtCode:tg==="bastar"||tg==="bittar"?"KS_TRH":"GNL_CHAR_1",valTpId:tg==="bastar"||tg==="bittar"?12:10,valDispHintId:tg==="bastar"||tg==="bittar"?721:722,regExprId:tg==="bastar"||tg==="bittar"?undefined:1000,isSyst:1,valueList:[],valueDisplayHint:{isActv:1,gnlTpId:tg==="bastar"||tg==="bittar"?721:722,name:tg==="bastar"||tg==="bittar"?"Date Input":"Number Input",shrtCode:tg==="bastar"||tg==="bittar"?"DATE":"INT"},valueType:{isActv:1,gnlTpId:tg==="bastar"||tg==="bittar"?12:10,name:tg==="bastar"||tg==="bittar"?"Date":"Number",shrtCode:tg==="bastar"||tg==="bittar"?"DATE":"INT"}},historyCapturedGeneralChars:[],capturedValue:{capturedValueList:[{val:vl,charId:tg==="bastar"||tg==="bittar"?22:1}]}});
                
                const s7=await mk('https://isgkatip.csgb.gov.tr/be/quote/updateFlowInstance',{body:{quoteKey:{businessInteractionInstanceId:id},flowInstancePage:{bsnInterFlowInscId:fid,bsnInterFlowPgId:10146,name:"Contract Info",scrOrd:4,postActnStId:1101},page:{type:"isg.katip.common.dto.bsninter.BusinessInteractionPageFormDTO",isActv:1,cdate:ct,cuser:5675110,isLocked:false,bsnInterPgFormId:7212,bsnInterPgId:10146,name:"Contract Info",descr:"Form Page",businessInteractionPageLayouts:[{isActv:1,bsnInterPgLytId:7229,bsnInterPgFormId:7212,name:"Assignment Info",businessInteractionPageChars:[cc(8589,7229,"bastar",bt),cc(8590,7229,"bittar",et)]},{isActv:1,bsnInterPgLytId:7230,bsnInterPgFormId:7212,name:"Equipment Info",businessInteractionPageChars:[cc(8591,7230,"bas_kap_say",basKap),cc(8592,7230,"kal_ekip_say",kaldirma),cc(8593,7230,"tes_say",tesisat),cc(8594,7230,"tez_say",tezgah),cc(8595,7230,"end_raf_say",raf),cc(8596,7230,"is_mak_say",makine)]},{isActv:1,bsnInterPgLytId:7231,bsnInterPgFormId:7212,name:"Accredited Equipment",businessInteractionPageChars:[cc(8597,7231,"lpg_say",lpg),cc(8598,7231,"yur_mer_say",merdiven),cc(8599,7231,"kren_say",kren),cc(8600,7231,"asi_eri_say",erisim)]}],businessInteractionName:"CONTRACT",businessInteractionInstanceId:id,tags:{bastar:bt,bittar:et,bas_kap_say:basKap,kal_ekip_say:kaldirma,tes_say:tesisat,tez_say:tezgah,end_raf_say:raf,is_mak_say:makine,lpg_say:lpg,yur_mer_say:merdiven,kren_say:kren,asi_eri_say:erisim}},operation:{isActv:1,cdate:ct,cuser:5675110,uuser:5675110,businessInteractionPageOperationId:26510,operationActionType:10,businessInteractionPageOperationName:"Next",businessInteractionPageOperationShortCode:"NEXT"}}},t);
                
                const rs=tm2(JSON.stringify(s7));
                if(!rs.b)throw new Error(rs.t||'Form hatasƒ±');
                
                return{basarili:true,tur,sgkNo,tcKimlik:tcKimlikNo,instanceId:id,fa,pa};
            }catch(e){
                throw e;
            }
        }
        
        function vl(tx){
            const ls=tx.split('\n').filter(l=>l.trim()!=='');
            const r={v:[],iv:[],t:ls.length};
            const isDetsis = currentMode === 'detsis';
            const isyeriHane = isDetsis ? 8 : 26;
            const isyeriLabel = isDetsis ? 'DetSis' : 'SGK';
            
            ls.forEach((l,i)=>{
                const ln=i+1;
                const ps=l.split(';');
                if(ps.length!==13){r.iv.push({l:ln,d:l,e:'13 alan gerekli'});return}
                const[tur,sgk,tc,bk,kl,ts,tz,rf,mk,lp,mr,kr,er]=ps.map(p=>p.trim());
                const es=[];
                if(!/^\d+$/.test(tur))es.push('T√ºr sayƒ± olmalƒ±');
                
                // Mode'a g√∂re i≈üyeri no validasyonu
                const isyeriRegex = new RegExp(`^\\d{${isyeriHane}}$`);
                if(!isyeriRegex.test(sgk))es.push(`${isyeriLabel} ${isyeriHane} hane`);
                
                if(!/^\d{11}$/.test(tc))es.push('TC 11 hane');
                [bk,kl,ts,tz,rf,mk,lp,mr,kr,er].forEach((e,x)=>{if(!/^\d+$/.test(e))es.push(['BK','Kld','TS','Tzg','Rf','Mkn','LPG','Mrd','Krn','Er≈ü'][x]+' sayƒ± olmalƒ±')});
                if(es.length===0){r.v.push({l:ln,d:l,tur,sgkNo:sgk,tcKimlikNo:tc,basKap:bk,kaldirma:kl,tesisat:ts,tezgah:tz,raf:rf,makine:mk,lpg:lp,merdiven:mr,kren:kr,erisim:er})}else{r.iv.push({l:ln,d:l,e:es.join(', ')})}
            });
            return r;
        }
        
        // ƒ∞SG Katip'e G√∂nder
        async function sendToISGKatip() {
            // Site kontrol√º
            if (window.location.hostname !== 'isgkatip.csgb.gov.tr') {
                alert('‚ùå Bu √∂zellik sadece isgkatip.csgb.gov.tr adresinde √ßalƒ±≈üƒ±r!\n\nL√ºtfen √∂nce ƒ∞SG Katip sitesine giri≈ü yapƒ±n, ardƒ±ndan bu formu tekrar a√ßƒ±n.');
                return;
            }
            
            if (dataLines.length === 0) {
                alert('‚ö†Ô∏è G√∂nderilecek veri yok!');
                return;
            }
            
            const output = document.getElementById('output').value.trim();
            const vr = vl(output);
            
            if (vr.iv.length > 0) {
                alert('‚ùå Ge√ßersiz veriler var! L√ºtfen d√ºzeltin.\n\n' + vr.iv.map(i => `Satƒ±r ${i.l}: ${i.e}`).join('\n'));
                return;
            }
            
            if (!confirm(`${vr.v.length} kayƒ±t ƒ∞SG Katip'e g√∂nderilecek.\n\nDevam etmek istiyor musunuz?`)) {
                return;
            }
            
            // Progress section g√∂ster
            const progressSection = document.getElementById('progressSection');
            const progressBar = document.getElementById('progressBar');
            const progressHeader = document.getElementById('progressHeader');
            const progressMessages = document.getElementById('progressMessages');
            const resultSummary = document.getElementById('resultSummary');
            
            progressSection.classList.add('show');
            progressHeader.textContent = 'ƒ∞SG Katip\'e G√∂nderiliyor...';
            progressMessages.innerHTML = '';
            resultSummary.style.display = 'none';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            const results = [];
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < vr.v.length; i++) {
                const item = vr.v[i];
                const percent = Math.round(((i + 1) / vr.v.length) * 100);
                
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';
                progressHeader.textContent = `ƒ∞≈üleniyor: ${i + 1}/${vr.v.length}`;
                
                const statusDiv = document.createElement('div');
                statusDiv.className = 'progress-status';
                statusDiv.innerHTML = `<strong>Satƒ±r ${i + 1}:</strong> ${item.sgkNo} - ${item.tcKimlikNo} i≈üleniyor...`;
                progressMessages.appendChild(statusDiv);
                progressMessages.scrollTop = progressMessages.scrollHeight;
                
                try {
                    const result = await pk(item);
                    successCount++;
                    
                    statusDiv.className = 'progress-status success';
                    statusDiv.innerHTML = `<strong>‚úÖ Satƒ±r ${i + 1}:</strong> ${result.fa} - ${result.pa}
                        <div class="progress-detail">ID: ${result.instanceId}</div>`;
                    
                    results.push({ ...result, satir: i + 1 });
                    
                } catch (error) {
                    errorCount++;
                    const errorMsg = tm2(error.message);
                    
                    statusDiv.className = 'progress-status error';
                    statusDiv.innerHTML = `<strong>‚ùå Satƒ±r ${i + 1}:</strong> ${item.sgkNo} - ${item.tcKimlikNo}
                        <div class="progress-detail">${errorMsg.t}</div>`;
                    
                    results.push({ satir: i + 1, basarili: false, hata: errorMsg.t, veri: item });
                }
                
                // 2 saniye bekle
                await new Promise(res => setTimeout(res, 2000));
            }
            
            // √ñzet g√∂ster
            progressHeader.textContent = '‚úÖ Tamamlandƒ±!';
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            
            resultSummary.style.display = 'grid';
            resultSummary.innerHTML = `
                <div class="result-card info">
                    <div class="result-card-number">${vr.v.length}</div>
                    <div class="result-card-label">Toplam</div>
                </div>
                <div class="result-card success">
                    <div class="result-card-number" style="color: #28a745;">${successCount}</div>
                    <div class="result-card-label">Ba≈üarƒ±lƒ±</div>
                </div>
                <div class="result-card error">
                    <div class="result-card-number" style="color: #dc3545;">${errorCount}</div>
                    <div class="result-card-label">Hatalƒ±</div>
                </div>
            `;
            
            alert(`‚úÖ ƒ∞≈ülem tamamlandƒ±!\n\nBa≈üarƒ±lƒ±: ${successCount}\nHatalƒ±: ${errorCount}`);
        }
    </script>
</body>
</html>
