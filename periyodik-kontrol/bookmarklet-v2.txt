javascript:(function(){
    // Modal varsa gÃ¶ster, yoksa oluÅŸtur
    if(document.getElementById('isgPeriyodikKontrolModal')){
        document.getElementById('isgPeriyodikKontrolModal').style.display='flex';
        return;
    }
    
    // GitHub'dan form HTML'ini Ã§ek
    const formUrl = 'https://alperduryaz.github.io/isgkatip-otomasyon/periyodik-kontrol/form.html';
    
    fetch(formUrl)
        .then(response => response.text())
        .then(formHtml => {
            // Modal container oluÅŸtur
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'isgPeriyodikKontrolModal';
            modalOverlay.style.cssText = 'display:flex !important;position:fixed !important;top:0 !important;left:0 !important;width:100% !important;height:100% !important;background:rgba(0,0,0,0.6) !important;z-index:10001 !important;justify-content:center !important;align-items:center !important;overflow-y:auto !important;';
            
            // Modal content wrapper
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background:white !important;border-radius:8px !important;width:95% !important;max-width:1400px !important;max-height:95vh !important;overflow-y:auto !important;box-shadow:0 4px 20px rgba(0,0,0,0.3) !important;position:relative !important;margin:20px !important;';
            
            // Form HTML'ini parse et
            const parser = new DOMParser();
            const doc = parser.parseFromString(formHtml, 'text/html');
            
            // Body iÃ§eriÄŸini al
            const formBody = doc.querySelector('.container');
            if (formBody) {
                modalContent.appendChild(formBody.cloneNode(true));
            } else {
                modalContent.innerHTML = formHtml;
            }
            
            // Kapat butonu ekle
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'âœ•';
            closeBtn.style.cssText = 'position:absolute !important;top:15px !important;right:15px !important;background:#dc3545 !important;color:white !important;border:none !important;width:35px !important;height:35px !important;border-radius:50% !important;cursor:pointer !important;font-size:20px !important;font-weight:bold !important;z-index:10 !important;';
            closeBtn.onclick = () => modalOverlay.style.display = 'none';
            modalContent.appendChild(closeBtn);
            
            // "Katibe GÃ¶nder" butonu ekle
            const sendSection = document.createElement('div');
            sendSection.style.cssText = 'margin:20px;padding:20px;background:#f8f9fa;border-radius:8px;border-top:2px solid #17a2b8;';
            sendSection.innerHTML = `
                <h3 style="margin:0 0 15px 0;color:#17a2b8;font-size:18px;">ğŸš€ Ä°SG Katip'e GÃ¶nder</h3>
                <div id="sendProgress" style="display:none;margin:15px 0;padding:15px;background:#e9ecef;border-radius:4px;"></div>
                <div style="display:flex;gap:10px;">
                    <button id="btnValidate" style="padding:10px 20px;background:#28a745;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;">âœ“ Kontrol Et</button>
                    <button id="btnSendAll" style="padding:10px 20px;background:#17a2b8;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;">ğŸš€ Toplu KayÄ±t Gir</button>
                </div>
            `;
            
            // Output div'den sonra ekle
            setTimeout(() => {
                const outputDiv = modalContent.querySelector('.output-section');
                if (outputDiv) {
                    outputDiv.parentNode.insertBefore(sendSection, outputDiv.nextSibling);
                }
                
                // Buton event'lerini baÄŸla
                attachSendButtonEvents();
            }, 100);
            
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            
            // ESC tuÅŸu ile kapat
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modalOverlay.style.display === 'flex') {
                    modalOverlay.style.display = 'none';
                }
            });
            
            // Overlay'e tÄ±klayÄ±nca kapat
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.style.display = 'none';
                }
            });
        })
        .catch(error => {
            alert('Form yÃ¼klenemedi: ' + error.message);
        });
    
    // API fonksiyonlarÄ± (mevcut modal'dan)
    function mk(u,d,t){return fetch(u,{method:'POST',headers:{'Accept':'*/*','Content-Type':'application/json','token':t,'Origin':'https://isgkatip.csgb.gov.tr','Referer':'https://isgkatip.csgb.gov.tr/surec/hizmet-sozlesme-surec'},body:JSON.stringify(d)}).then(r=>r.json())}
    
    function ts(){return new Date().toISOString().slice(0,-1)}
    function tm(){let d=new Date();d.setDate(d.getDate()+1);return d.toISOString()}
    function t180(){let d=new Date();d.setDate(d.getDate()+180);return d.toISOString()}
    function fn(r,p){if(!r||!r.body||!r.body.flowInstances)return null;const f=r.body.flowInstances.find(x=>x.flowInstancePage?.bsnInterFlowPgId===p);return f?f.businessInteractionFlowInstanceId:r.body.flowInstances[r.body.flowInstances.length-1]?.businessInteractionFlowInstanceId}
    
    function tm2(m){if(!m)return{t:'',b:false};let s=m.toString();const ok=s.includes('Ä°ÅŸleminiz baÅŸarÄ±yla gerÃ§ekleÅŸtirilmiÅŸtir')||s.includes('baÅŸarÄ±yla gerÃ§ekleÅŸtirilmiÅŸtir');s=s.replace(/BaÅŸvuruya ait bir sonraki ekranda iÅŸlem yapma yetkiniz olmadÄ±ÄŸÄ±ndan ana menÃ¼ye yÃ¶nlendirileceksiniz\.?/g,'').replace(/isg\.katip\.common\.exception\.business\.IsgBusinessException,\s*/g,'').replace(/\*\*\*/g,'').trim();if(ok)s='BaÅŸarÄ±yla oluÅŸturuldu';return{t:s,b:ok}}
    
    async function pk(v){const t=sessionStorage.getItem('token');if(!t)throw new Error('Token bulunamadÄ±');const{tur,sgkNo,tcKimlikNo,basKap,kaldirma,tesisat,tezgah,raf,makine,lpg,merdiven,kren,erisim}=v;let id=null,fid=null,fa='-',pa='-';const bt=tm(),et=t180();try{const s1=await mk('https://isgkatip.csgb.gov.tr/be/bsn-inter/submit',{body:{businessInteraction:{bsnInterId:tur},operationType:"ADD"}},t);if(s1.responseStatus!=='SUCCESS')throw new Error('BaÅŸlatma hatasÄ±');id=s1.body.businessInteractionInstanceId;fid=s1.body.flowInstances?.[0]?.businessInteractionFlowInstanceId;const s2=await mk('https://isgkatip.csgb.gov.tr/be/quote/updateFlowInstance',{body:{quoteKey:{businessInteractionInstanceId:id},flowInstancePage:{bsnInterFlowInscId:fid,bsnInterFlowPgId:10143,name:"Bilgilendirme SayfasÄ±",scrOrd:1,postActnStId:1101},page:{type:"isg.katip.common.dto.bsninter.BusinessInteractionPageWarningDTO",isActv:1,isLocked:false,bsnInterPgWrngId:8212,bsnInterPgId:10143,name:"Bilgilendirme SayfasÄ±",businessInteractionName:"AKREDÄ°TE MUAYENE KURULUÅU Ä°LE SGK Ä°ÅYERÄ° ARASINDAKÄ° PERÄ°YODÄ°K KONTROL HÄ°ZMETÄ° ALIMI SÃ–ZLEÅMESÄ°",businessInteractionInstanceId:id},operation:{isActv:1,businessInteractionPageOperationId:26507,operationActionType:10,businessInteractionPageOperationName:"Ä°leri",businessInteractionPageOperationShortCode:"NEXT"}}},t);fid=fn(s2,10144);const s3=await mk('https://isgkatip.csgb.gov.tr/be/bsninter/conf/participant/hasRole',{body:{bsnInterPrtcptId:13283,rowId:sgkNo,dataTpId:280}},t);if(s3.responseStatus!=='SUCCESS')throw new Error('Ä°ÅŸyeri bulunamadÄ±');const fr=s3.body?.rowId||sgkNo;fa=s3.body?.title||'-';const s4=await mk('https://isgkatip.csgb.gov.tr/be/quote/updateFlowInstance',{body:{quoteKey:{businessInteractionInstanceId:id},flowInstancePage:{bsnInterFlowInscId:fid,bsnInterFlowPgId:10144,name:"SÃ¶zleÅŸme YapÄ±lacak Ä°ÅŸyeri SeÃ§imi SayfasÄ±",descr:"Participant Page",scrOrd:2,postActnStId:1101,isAutoComp:1,isPnr:1},page:{type:"isg.katip.common.dto.bsninter.participant.BusinessInteractionPageParticipantDTO",isActv:1,isLocked:false,bsnInterPgPrtcptId:6146,name:"SÃ¶zleÅŸme YapÄ±lacak Ä°ÅŸyeri SeÃ§imi SayfasÄ±",descr:"Participant Page",participants:[{isActv:1,bsnInterPgPrtcptItemId:6146,bsnInterPrtcptId:13283,participantDataTypeId:280,ruleSetId:1206,verNo:1,name:"SÃ¶zleÅŸme YapÄ±lacak Ä°ÅŸyeri",participantName:"isyeri",rowId:fr,dataTpId:280}],businessInteractionName:"AKREDÄ°TE MUAYENE KURULUÅU Ä°LE SGK Ä°ÅYERÄ° ARASINDAKÄ° PERÄ°YODÄ°K KONTROL HÄ°ZMETÄ° ALIMI SÃ–ZLEÅMESÄ°",businessInteractionInstanceId:id,tarafBilgisi:fr+",280"},operation:{isActv:1,businessInteractionPageOperationId:26508,operationActionType:10,businessInteractionPageOperationName:"Ä°leri",businessInteractionPageOperationShortCode:"NEXT"}}},t);fid=fn(s4,10145);const s5=await mk('https://isgkatip.csgb.gov.tr/be/bsninter/conf/participant/hasRole',{body:{bsnInterPrtcptId:13282,rowId:tcKimlikNo,dataTpId:300}},t);if(s5.responseStatus!=='SUCCESS')throw new Error('Personel bulunamadÄ±');const pr=s5.body?.rowId||tcKimlikNo;pa=s5.body?.title||'-';const s6=await mk('https://isgkatip.csgb.gov.tr/be/quote/updateFlowInstance',{body:{quoteKey:{businessInteractionInstanceId:id},flowInstancePage:{bsnInterFlowInscId:fid,bsnInterFlowPgId:10145,name:"GÃ¶revlendirme YapÄ±lacak PK Yetkilisi SeÃ§im SayfasÄ±",descr:"Participant Page",scrOrd:3,postActnStId:1101,isAutoComp:1,isPnr:1},page:{type:"isg.katip.common.dto.bsninter.participant.BusinessInteractionPageParticipantDTO",isActv:1,isLocked:false,bsnInterPgPrtcptId:6147,name:"GÃ¶revlendirme YapÄ±lacak PK Yetkilisi SeÃ§im SayfasÄ±",descr:"Participant Page",participants:[{isActv:1,bsnInterPgPrtcptItemId:6147,bsnInterPrtcptId:13282,participantDataTypeId:300,ruleSetId:1205,verNo:1,name:"GÃ¶revlendirilecek Periyodik Kontrol Yetkilisi",participantName:"kontrolpersoneli",rowId:pr,dataTpId:300}],businessInteractionName:"AKREDÄ°TE MUAYENE KURULUÅU Ä°LE SGK Ä°ÅYERÄ° ARASINDAKÄ° PERÄ°YODÄ°K KONTROL HÄ°ZMETÄ° ALIMI SÃ–ZLEÅMESÄ°",businessInteractionInstanceId:id,tarafBilgisi:fr+",280"},operation:{isActv:1,businessInteractionPageOperationId:26509,operationActionType:10,businessInteractionPageOperationName:"Ä°leri",businessInteractionPageOperationShortCode:"NEXT"}}},t);fid=fn(s6,10146);const ct=ts();const cc=(i,l,tg,vl)=>({isActv:1,cdate:ct,cuser:5675110,uuser:5675110,bsnInterPgCharId:i,bsnInterPgLytId:l,charId:tg==="bastar"||tg==="bittar"?22:1,name:"",isOvrdn:0,isOpt:0,tag:tg,isLocked:0,comments:[],gnlChar:{isActv:1,charId:tg==="bastar"||tg==="bittar"?22:1,name:tg==="bastar"||tg==="bittar"?"KISA TARIH ALANI":"NUMERIK ALAN",shrtCode:tg==="bastar"||tg==="bittar"?"KS_TRH":"GNL_CHAR_1",valTpId:tg==="bastar"||tg==="bittar"?12:10,valDispHintId:tg==="bastar"||tg==="bittar"?721:722,regExprId:tg==="bastar"||tg==="bittar"?undefined:1000,isSyst:1,valueList:[],valueDisplayHint:{isActv:1,gnlTpId:tg==="bastar"||tg==="bittar"?721:722,name:tg==="bastar"||tg==="bittar"?"Date Input":"Number Input",shrtCode:tg==="bastar"||tg==="bittar"?"DATE":"INT"},valueType:{isActv:1,gnlTpId:tg==="bastar"||tg==="bittar"?12:10,name:tg==="bastar"||tg==="bittar"?"Date":"Number",shrtCode:tg==="bastar"||tg==="bittar"?"DATE":"INT"}},historyCapturedGeneralChars:[],capturedValue:{capturedValueList:[{val:vl,charId:tg==="bastar"||tg==="bittar"?22:1}]}});const s7=await mk('https://isgkatip.csgb.gov.tr/be/quote/updateFlowInstance',{body:{quoteKey:{businessInteractionInstanceId:id},flowInstancePage:{bsnInterFlowInscId:fid,bsnInterFlowPgId:10146,name:"SÃ¶zleÅŸme Bilgileri GiriÅŸ SayfasÄ±",scrOrd:4,postActnStId:1101},page:{type:"isg.katip.common.dto.bsninter.BusinessInteractionPageFormDTO",isActv:1,cdate:ct,cuser:5675110,isLocked:false,bsnInterPgFormId:7212,bsnInterPgId:10146,name:"SÃ¶zleÅŸme Bilgileri GiriÅŸ SayfasÄ±",descr:"Form Initialize Page",businessInteractionPageLayouts:[{isActv:1,bsnInterPgLytId:7229,bsnInterPgFormId:7212,name:"GÃ¶revlendirme Bilgileri",businessInteractionPageChars:[cc(8589,7229,"bastar",bt),cc(8590,7229,"bittar",et)]},{isActv:1,bsnInterPgLytId:7230,bsnInterPgFormId:7212,name:"Rapor DÃ¼zenlenecek Ekipman Bilgileri",businessInteractionPageChars:[cc(8591,7230,"bas_kap_say",basKap),cc(8592,7230,"kal_ekip_say",kaldirma),cc(8593,7230,"tes_say",tesisat),cc(8594,7230,"tez_say",tezgah),cc(8595,7230,"end_raf_say",raf),cc(8596,7230,"is_mak_say",makine)]},{isActv:1,bsnInterPgLytId:7231,bsnInterPgFormId:7212,name:"Rapor DÃ¼zenlenecek Akreditasyona Tabi Ekipman Bilgileri",businessInteractionPageChars:[cc(8597,7231,"lpg_say",lpg),cc(8598,7231,"yur_mer_say",merdiven),cc(8599,7231,"kren_say",kren),cc(8600,7231,"asi_eri_say",erisim)]}],businessInteractionName:"AKREDÄ°TE MUAYENE KURULUÅU Ä°LE SGK Ä°ÅYERÄ° ARASINDAKÄ° PERÄ°YODÄ°K KONTROL HÄ°ZMETÄ° ALIMI SÃ–ZLEÅMESÄ°",businessInteractionInstanceId:id,tags:{bastar:bt,bittar:et,bas_kap_say:basKap,kal_ekip_say:kaldirma,tes_say:tesisat,tez_say:tezgah,end_raf_say:raf,is_mak_say:makine,lpg_say:lpg,yur_mer_say:merdiven,kren_say:kren,asi_eri_say:erisim}},operation:{isActv:1,cdate:ct,cuser:5675110,uuser:5675110,businessInteractionPageOperationId:26510,operationActionType:10,businessInteractionPageOperationName:"Ä°leri",businessInteractionPageOperationShortCode:"NEXT"}}},t);const rs=tm2(JSON.stringify(s7));if(!rs.b)throw new Error(rs.t||'Form hatasÄ±');return{basarili:true,tur,sgkNo,tcKimlik:tcKimlikNo,instanceId:id,fa,pa}}catch(e){throw e}}
    
    function vl(tx){const ls=tx.split('\n').filter(l=>l.trim()!=='');const r={v:[],iv:[],t:ls.length};ls.forEach((l,i)=>{const ln=i+1;const ps=l.split(';');if(ps.length!==13){r.iv.push({l:ln,d:l,e:'13 alan olmalÄ±'});return}const[tur,sgk,tc,bk,kl,ts,tz,rf,mk,lp,mr,kr,er]=ps.map(p=>p.trim());const es=[];if(!/^\d+$/.test(tur))es.push('TÃ¼r sayÄ± olmalÄ±');if(!/^\d{26}$/.test(sgk))es.push('SGK 26 hane');if(!/^\d{11}$/.test(tc))es.push('TC 11 hane');[bk,kl,ts,tz,rf,mk,lp,mr,kr,er].forEach((e,x)=>{if(!/^\d+$/.test(e))es.push(['BasKap','KaldÄ±rma','Tesisat','Tezgah','Raf','Makine','LPG','Merdiven','Kren','EriÅŸim'][x]+' sayÄ± olmalÄ±')});if(es.length===0){r.v.push({l:ln,d:l,tur,sgkNo:sgk,tcKimlikNo:tc,basKap:bk,kaldirma:kl,tesisat:ts,tezgah:tz,raf:rf,makine:mk,lpg:lp,merdiven:mr,kren:kr,erisim:er})}else{r.iv.push({l:ln,d:l,e:es.join(', ')})}});return r}
    
    function attachSendButtonEvents() {
        const btnValidate = document.getElementById('btnValidate');
        const btnSendAll = document.getElementById('btnSendAll');
        const progressDiv = document.getElementById('sendProgress');
        
        if (!btnValidate || !btnSendAll) return;
        
        btnValidate.onclick = function() {
            const output = document.getElementById('output');
            if (!output) {
                alert('Ã‡Ä±ktÄ± bulunamadÄ±!');
                return;
            }
            
            const v = output.value.trim();
            if (!v) {
                alert('Veri giriniz!');
                return;
            }
            
            const vr = vl(v);
            progressDiv.style.display = 'block';
            
            if (vr.iv.length === 0) {
                progressDiv.style.backgroundColor = '#d4edda';
                progressDiv.style.color = '#155724';
                progressDiv.style.border = '1px solid #c3e6cb';
                progressDiv.innerHTML = `<strong>âœ… GeÃ§erli!</strong><br>Toplam: ${vr.t}<br>GeÃ§erli: ${vr.v.length}<br>HatalÄ±: ${vr.iv.length}`;
            } else {
                progressDiv.style.backgroundColor = '#f8d7da';
                progressDiv.style.color = '#721c24';
                progressDiv.style.border = '1px solid #f5c6cb';
                let h = `<strong>âŒ Hata!</strong><br>Toplam: ${vr.t}<br>GeÃ§erli: ${vr.v.length}<br>HatalÄ±: ${vr.iv.length}<br><br>`;
                vr.iv.forEach(i => h += `<div style="margin:5px 0;padding:5px;background:#fff;border-radius:3px"><strong>SatÄ±r ${i.l}:</strong> ${i.d}<br><span style="color:#dc3545;font-size:12px">${i.e}</span></div>`);
                progressDiv.innerHTML = h;
            }
        };
        
        btnSendAll.onclick = async function() {
            const output = document.getElementById('output');
            if (!output) {
                alert('Ã‡Ä±ktÄ± bulunamadÄ±!');
                return;
            }
            
            const v = output.value.trim();
            if (!v) {
                alert('Veri giriniz!');
                return;
            }
            
            const vr = vl(v);
            if (vr.iv.length > 0) {
                alert('HatalÄ± veri var! Ã–nce "Kontrol Et" yapÄ±n.');
                return;
            }
            
            if (!confirm(`${vr.v.length} kayÄ±t yapÄ±lacak. Devam?`)) return;
            
            btnSendAll.disabled = true;
            btnSendAll.innerHTML = 'Ä°ÅŸlem yapÄ±lÄ±yor...';
            progressDiv.style.display = 'block';
            progressDiv.innerHTML = `<strong>BaÅŸlatÄ±ldÄ±...</strong><br>Toplam: ${vr.v.length}`;
            
            const sn = [];
            for (let i = 0; i < vr.v.length; i++) {
                const vv = vr.v[i];
                try {
                    progressDiv.innerHTML = `<strong>Ä°ÅŸlem yapÄ±lÄ±yor...</strong><br>${i+1}/${vr.v.length}<br>TÃ¼r: ${vv.tur} - SGK: ${vv.sgkNo}`;
                    const s = await pk(vv);
                    sn.push(s);
                    await new Promise(res => setTimeout(res, 2000));
                } catch(e) {
                    const ha = tm2(e.message);
                    sn.push({satir:i+1, veri:vv, hata:ha.t, basarili:ha.b});
                }
            }
            
            const ok = sn.filter(s => s.basarili).length;
            const nk = sn.filter(s => !s.basarili).length;
            let rp = `<strong>ğŸ“Š TAMAMLANDI</strong><br>âœ… BaÅŸarÄ±lÄ±: ${ok}<br>âŒ Hata: ${nk}<br><br>`;
            
            sn.forEach((s, i) => {
                if (s.basarili) {
                    const faa = s.fa || s.veri?.sgkNo || 'N/A';
                    const paa = s.pa || s.veri?.tcKimlikNo || 'N/A';
                    rp += `<div style="margin:2px 0;padding:3px;background:#d4edda;border-radius:3px">${i+1}. âœ… ${faa} - ${paa} (ID: ${s.instanceId||'OK'})</div>`;
                } else {
                    rp += `<div style="margin:2px 0;padding:3px;background:#f8d7da;border-radius:3px">${i+1}. âŒ ${s.veri.sgkNo} - HATA: ${s.hata}</div>`;
                }
            });
            
            progressDiv.style.backgroundColor = nk === 0 ? '#d4edda' : '#fff3cd';
            progressDiv.innerHTML = rp;
            btnSendAll.disabled = false;
            btnSendAll.innerHTML = 'ğŸš€ Toplu KayÄ±t Gir';
            alert(`TamamlandÄ±!\nâœ… BaÅŸarÄ±lÄ±: ${ok}\nâŒ Hata: ${nk}`);
        };
    }
})();
